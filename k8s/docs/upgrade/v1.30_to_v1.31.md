# Upgrade Guide: v1.30.x → v1.31.14

This document explains how to upgrade your Kubernetes cluster (kubeadm-based) from **v1.30.x** to **v1.31.14** (package version `1.31.14-1.1`).  
Assumptions:
- You have a kubeadm based cluster on Debian/Ubuntu style OS.
- You have SSH access to control plane (master) and worker nodes.
- You have taken backups (etcd or control‐plane etc.) and verified cluster health.
- Replace `worker-node-1.example.com`, `worker-node-2.example.com`, etc with your actual node names.

---

## 1. Master Node (Control Plane) Upgrade

### 1.1 Setup v1.31 APT Repository  
```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' \
  | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
apt-cache madison kubeadm
````

### 1.2 Install kubeadm 1.31.14

```bash
sudo apt-mark unhold kubeadm
sudo apt-get install -y kubeadm=1.31.14-1.1
sudo apt-mark hold kubeadm

kubeadm version
```

### 1.3 Upgrade Control Plane

```bash
sudo kubeadm upgrade apply v1.31.14
```

If you encounter timeout or known preflight issues you may optionally use:

```bash
sudo kubeadm upgrade apply v1.31.14 --ignore-preflight-errors=all
```

### 1.4 Upgrade kubelet & kubectl (Master)

```bash
sudo apt-mark unhold kubelet kubectl
sudo apt-get install -y kubelet=1.31.14-1.1 kubectl=1.31.14-1.1
sudo apt-mark hold kubelet kubectl

sudo systemctl daemon-reload
sudo systemctl restart kubelet
```

---

## 2. Worker Node 1 Upgrade

### 2.1 Setup v1.31 APT Repository (on worker-1)

```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' \
  | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
apt-cache madison kubeadm
```

### 2.2 Install kubeadm 1.31.14 (on worker-1)

```bash
sudo apt-mark unhold kubeadm
sudo apt-get install -y kubeadm=1.31.14-1.1
sudo apt-mark hold kubeadm
```

### 2.3 Upgrade Node Configuration (on worker-1)

```bash
sudo kubeadm upgrade node
```

### 2.4 Drain Worker Node (from master)

```bash
kubectl drain worker-node-1.example.com \
  --ignore-daemonsets --delete-emptydir-data --force
```

### 2.5 Install kubelet & kubectl (on worker-1)

```bash
sudo apt-mark unhold kubelet kubectl
sudo apt-get install -y kubelet=1.31.14-1.1 kubectl=1.31.14-1.1
sudo apt-mark hold kubelet kubectl

sudo systemctl daemon-reload
sudo systemctl restart kubelet
```

### 2.6 Uncordon Worker Node (from master)

```bash
kubectl uncordon worker-node-1.example.com
```

---

## 3. Worker Node 2 Upgrade

### 3.1 Setup v1.31 APT Repository (on worker-2)

```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key \
  | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' \
  | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
apt-cache madison kubeadm
```

### 3.2 Install kubeadm 1.31.14 (on worker-2)

```bash
sudo apt-mark unhold kubeadm
sudo apt-get install -y kubeadm=1.31.14-1.1
sudo apt-mark hold kubeadm
```

### 3.3 Upgrade Node Configuration (on worker-2)

```bash
sudo kubeadm upgrade node
```

### 3.4 Drain Worker Node (from master)

```bash
kubectl drain worker-node-2.example.com \
  --ignore-daemonsets --delete-emptydir-data --force
```

### 3.5 Install kubelet & kubectl (on worker-2)

```bash
sudo apt-mark unhold kubelet kubectl
sudo apt-get install -y kubelet=1.31.14-1.1 kubectl=1.31.14-1.1
sudo apt-mark hold kubelet kubectl

sudo systemctl daemon-reload
sudo systemctl restart kubelet
```

### 3.6 Uncordon Worker Node (from master)

```bash
kubectl uncordon worker-node-2.example.com
```

---

## 4. Post-Upgrade Verification

```bash
kubectl get nodes -o wide
kubectl get pods -A
kubectl version --short
kubeadm version
```

Confirm:

* All nodes report version **v1.31.14**
* Nodes show `Ready` status
* System pods in `kube-system` are running as expected

---

## 5. References and Notes

* Make sure you have an etcd backup or control-plane snapshot before starting.
* Use `apt-mark hold` to freeze kubeadm/kubelet/kubectl at the target version.
* If control-plane is HA (multiple masters), upgrade each master in sequence.
* If `kubeadm upgrade apply` fails due to timeouts or pre-flight issues, you may use the `--ignore-preflight-errors=all` flag—but always review logs carefully.




